<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
    xmlns:moya="http://moyaproject.com"
	xmlns:w="http://moyaproject.com/widgets"
    xmlns:m="http://moyaproject.com"
    xmlns:db="http://moyaproject.com/db"
    xmlns:let="http://moyaproject.com/let">

    <choices libname="choices.markup">
        <choice value="text" label="Text"/>
        <choice value="bbcode" label="BBCode"/>
        <choice value="markdown" label="Markdown"/>
        <choice value="html" label="HTML"/>
    </choices>

    <choices libname="choices.event">
        <choice value="text"/>
        <choice value="image"/>
    </choices>

    <form libname="form.event" legend="New Event" style="horizontal" xmlns="http://moyaproject.com/forms">
    	<input name="stream" label="Stream" placeholder="Stream ID" required="yes"/>
    	<password name="password" required="no" label="Password" placeholder="Stream password"/>
        <input name="title" label="Title" required="yes" placeholder="Descriptive title of this event"/>
        <input name="time" label="Time" type="integer" placeholder="epoch time (leave blank for current time)"/>
        <select name="type" maxlength="30" label="Event Type">
            <m:for src="data:'event_types.json'" dst="type">
                <option value="${type}"/>
            </m:for>
        </select>
        <select name="priority" label="Priority" initial="0">
            <option value="-2">verbose (-2)</option>
            <option value="-1">informative (-1)</option>
            <option value="0">default priority (0)</option>
            <option value="+1">important (+1)</option>
            <option value="+2">urgent (+2)</option>
        </select>
        <input name="generator" label="Generator" placeholder="Name of device that generated this event"/>
        <select name="markup" maxlength="20" label="Markup" initial="'markdown'">
            <option value="markdown"/>
            <option value="text"/>
            <option value="html"/>
        </select>
        <text-area name="text" label="Text" placeholder="Text associated with the event (will be processed as the above markup)"/>
        <upload name="image" label="Upload"/>
        <submit-button text="Upload"/>

        <validate-field field="image">
            <fail if="values.type=='image' and not bool:.request.FILES.image">Required for image type</fail>
        </validate-field>
        <validate-field field="password">
            <db:get model="#Stream" dst="stream" let:uuid="values.stream"/>
            <fail if="stream.user and not values.password">
                this stream requires a password
            </fail>
            <fail if="stream.user and stream.password != values.password">
                password failed
            </fail>
        </validate-field>
    </form>

    <form libname="form.stream.new" style="horizontal" xmlns="http://moyaproject.com/forms">
        <input name="title" label="Title" required="yes"
            placeholder="Title of the stream (used to generate a URL)"/>
        <text-area name="description" label="Description"
            placeholder="What will go in this stream?"/>
        <field>
            <m:bbcode>[url ${.request.host_url}${.urls.pages.showpage(pagename='tc')}]Terms and Conditions[/url]</m:bbcode>
        </field>
        <checkbox name="tc" text="I agree" required="yes"/>

        <submit-button text="Create Stream"/>
        <validate-field field="title">
            <error if="len:.user.streams gte .user.account.max_streams">
                Unable to create this stream, you have reached your limit
            </error>
            <db:if-exists model="#Stream"
                let:user="user" let:slug="slug:value">
                <fail>This title exists, please pick another</fail>
            </db:if-exists>
            <fail if="not slug:value">
                Can't make a slug out of this title
            </fail>
        </validate-field>
    </form>

    <form libname="form.stream.edit" style="horizontal" xmlns="http://moyaproject.com/forms">
        <hidden-input name="action" initial="'edit'"/>
        <input name="title" label="Title" required="yes"/>
        <input name="password" label="Password" help="Used by the API (leave blank to disable password access)"/>
        <text-area name="description" label="Description"/>
        <submit-button class="btn btn-round" text="Save"/>

        <validate-field field="title">
            <db:if-exists model="#Stream"
                let:user="stream.user" let:slug="slug:value" filter="#Stream.id != stream.id">
                <fail>This title exists, please pick another</fail>
            </db:if-exists>
            <fail if="not slug:value">
                Can't make a slug out of this title
            </fail>
        </validate-field>
    </form>

    <form libname="form.account.edit" style="horizontal" xmlns="http://moyaproject.com/forms">
        <text-area name="about" label="about" help="Shown on your streams page"/>
        <submit-button class="btn btn-round" text="Save"/>
    </form>

    <form libname="form.stream.image.edit" style="horizontal" xmlns="http://moyaproject.com/forms">
        <field label="current">

        </field>
    </form>

</moya>
