<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
    xmlns:let="http://moyaproject.com/let"
    xmlns:db="http://moyaproject.com/db">

    <handle signal="moya.comments.new-comment">
    	<let event_uuid="(partition:[signal.data.commentobject.object, '-'])[-1]"/>
    	<db:query model="#Event" let:uuid="event_uuid" dst="event"/>
    	<db:update src="event" let:numcomments="signal.data.commentobject.count"/>
    </handle>

    <handle signal="moya.auth.post-login">
        <let user="signal.data.user"/>
        <db:atomic>
            <if test="not user.account">
                <log-debug>Creating a user account</log-debug>
                <db:get-or-create model="#Account" let:user="user" dst="account"/>
                <log-debug>Creating an imagelib</log-debug>
                <db:create model="moya.imagelib#Collection" dst="account.imgcollection"/>
            </if>
        </db:atomic>
    </handle>

    <handle signal="db.post-create" sender="willmcgugan.timeline#Event">
        <let tags="signal.data.object.text_html|'hashtags'"/>
        <echo obj="tags"/>
    </handle>
</moya>
