<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
    xmlns:let="http://moyaproject.com/let"
    xmlns:db="http://moyaproject.com/db"
    xmlns:forms="http://moyaproject.com/forms"
    xmlns:tl="http://willmcgugan.com/timeline">

    <mountpoint name="main">
        <url route="/api/public/" methods="GET,POST" view='#jsonrpc.public' name="jsonrpc_public" />
        <url route="/api/private/" methods="GET,POST" view='#jsonrpc.private' name="jsonrpc_private" />
        <url route="/t/{timeline_id}/" methods="GET" view="#view.timeline" name="timeline" />
        <url route="/s/{stream_id}/" methods="GET" view="#view.stream" name="stream" />
    </mountpoint>

    <view libname="view.stream" template="stream.html">
        <tl:get-stream-required id=".url.stream_id" dst="stream"/>
        <get-url name="stream" let:stream_id="stream.uuid" dst="watch_url"/>
        <db:query model="#Event" let:stream="stream" maxresults="10" orderby="-time" dst="events"/>
        
        <dict dst="config"
            let:stream="stream.uuid"
            let:watcherurl="slashjoin:[.app.settings.watcher_url, watch_url]"
            let:time="events.first.time.epoch">
            <get-url name="jsonrpc_private" dst="rpc_url"/>
        </dict>

    </view>

    <view libname="view.timeline" template="stream.html">
        <tl:get-stream-required id=".url.stream_id" dst="stream"/>
        <let events="stream.events[:10]"/>
    </view>

</moya>
