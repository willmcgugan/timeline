<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
    xmlns:let="http://moyaproject.com/let"
    xmlns:db="http://moyaproject.com/db"
    xmlns:forms="http://moyaproject.com/forms"
    xmlns:tl="http://willmcgugan.com/timeline">

    <mountpoint name="main">
        <url route="/api/public/" methods="GET,POST" view='#jsonrpc.interface' name="jsonrpc" />
        <url route="/t/{timeline_id}/" methods="GET" view="#view.timeline" name="timeline" />
        <url route="/s/{stream_id}/" methods="GET" view="#view.stream" name="stream" />
    </mountpoint>

    <view libname="view.stream" template="stream.html">
        <tl:get-stream-required id=".url.stream_id" dst="stream"/>
        <get-url name="stream" let:stream_id="stream.uuid" dst="watch_url"/>
        <db:query model="#Event" let:stream="stream" maxresults="10" orderby="-time" dst="events"/>
        <breakpoint />
        <let recent="events.first" time="recent.time.epoch" />
    </view>

    <view libname="view.timeline" template="stream.html">
        <tl:get-stream-required id=".url.stream_id" dst="stream"/>
        <let events="stream.events[:10]"/>
    </view>

</moya>
