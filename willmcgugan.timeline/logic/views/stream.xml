<?xml version="1.0" encoding="UTF-8"?>
<moya xmlns="http://moyaproject.com"
    xmlns:let="http://moyaproject.com/let"
    xmlns:db="http://moyaproject.com/db"
    xmlns:forms="http://moyaproject.com/forms"
    xmlns:tl="http://willmcgugan.com/timeline"
    xmlns:fs="http://moyaproject.com/fs"
    xmlns:image="http://moyaproject.com/image"
    xmlns:tn="http://moyaproject.com/thumbnail">


    <view libname="view.front" template="front.html">

    </view>

    <view libname="view.stream" content="#content.stream">
        <tl:get-stream-required id=".url.stream_id" dst="stream"/>
        <tl:get-timeline dst="timeline" />
        <get-url name="stream" let:stream_id="stream.uuid" dst="watch_url"/>
        <db:query model="#Event" let:stream="stream" maxresults="10" orderby="-added_time" dst="events"/>

        <db:get model="#Subscription" dst="subscription"
            let:stream="stream" let:timeline="timeline"/>
    </view>

    <view libname="view.user.subscriptions" content="#content.user.subscriptions" requires=".user">
        <db:get-required model="moya.auth#User" dst="user"
            let:username=".url.username"/>
        <tl:get-timeline let:user="user" dst="timeline"/>
        <get-url name="user_subscriptions" let:username="user.username" dst="watch_url"/>
        <db:query model="#Event" dst="events" maxresults="10"
            filter="#Event.stream.id in timeline.streams" orderby="-time"/>
        <db:query model="#Subscription" let:timeline="timeline" dst="subscriptions"/>
    </view>

    <view libname="view.user.streams" content="#content.user.streams">
        <db:get-required model="moya.auth#User" dst="owner"
            let:username=".url.username"/>
        <tl:get-timeline let:user="owner" dst="timeline"/>
        <get-url name="user_streams" let:username="owner.username" dst="watch_url"/>
        <db:query model="#Event" dst="events" maxresults="10"
            filter="#Event.stream.user == owner" orderby="-time"/>
        <let user=".user"/>

        <db:query model="#Stream" src=".user.streams" orderby="title" dst="streams"/>
        

    </view>

    <view libname="view.user.stream" content="#content.stream">
        <db:get-required model="moya.auth#User" let:username=".url.username" dst="user"/>
        <tl:get-stream-required user="user" id=".url.stream_slug" dst="stream"/>
        <tl:get-timeline dst="timeline" />

        <get-url name="stream" let:stream_id="stream.uuid" dst="watch_url"/>
        <db:query model="#Event" let:stream="stream" maxresults="10" orderby="-added_time" dst="events"/>

        <db:get model="#Subscription" dst="subscription"
            let:stream="stream" let:timeline="timeline"/>

        <if test="stream.user == .user">

            <forms:get form="#form.stream.edit" dst="edit_form" src="stream"/>
            <if-post>
                <forms:validate src="edit_form" let:stream="stream">
                    <let data="edit_form.data"/>
                    <if test="data.action=='edit'">
                        <forms:apply src="edit_form" dst="stream"/>
                        <let stream.slug="slug:stream.title"/>
                        <tl:user-message>**Success** You clearly do not fear change!</tl:user-message>
                        <redirect name="user_stream" let:username="stream.user.username" let:stream_slug="stream.slug"/>
                    </if>
                </forms:validate>
            </if-post>

        </if>
    </view>

    <view libname="view.event" content="#content.event">
        <db:get-required model="#Event" let:uuid=".url.event_id" dst="event"/>
        <get-url name="event" let:event_id="event.uuid" dst="watch_url"/>
        <let stream="event.stream"/>

        <db:query model="#Event" dst="next_events"
            orderby="added_time"
            let:stream="stream" filter="#Event.added_time gt event.added_time"/>
        <db:query model="#Event" dst="previous_events"
            orderby="-added_time"
            let:stream="stream" filter="#Event.added_time lt event.added_time"/>
        <let next_event="next_events.first"
            previous_event="previous_events.first"/>

        <dict dst="config"
            let:page_id="'event-view'"
            let:time="events.first.time.epoch">
            <get-url name="jsonrpc_private" dst="rpc_url"/>
        </dict>
    </view>


</moya>
